{# Results area — swapped by HTMX on filter/paginate #}

{# Summary bar #}
<div class="flex flex-wrap items-center gap-4 mb-4 text-sm">
  <span class="font-semibold">{{ summary.count }} transaction{{ 's' if summary.count != 1 }}</span>
  <span class="text-error font-medium">Out: {{ "{:,.2f}".format(summary.total_out) }}</span>
  <span class="text-success font-medium">In: +{{ "{:,.2f}".format(summary.total_in) }}</span>
</div>

{% if error is defined and error %}
<div class="alert alert-error mb-4">
  <span>{{ error }}</span>
</div>
{% elif transactions|length == 0 %}
<div class="alert alert-info">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
  </svg>
  <span>No transactions found. Try adjusting filters or add a new transaction.</span>
</div>
{% else %}

{# ===== Desktop table (hidden on mobile) ===== #}
<div class="hidden lg:block overflow-x-auto">
  <table class="table table-zebra w-full">
    <thead>
      <tr>
        <th>Date</th>
        <th>Description</th>
        <th>Card</th>
        <th>Kind</th>
        <th class="text-right">Amount</th>
        <th class="text-center">Sources</th>
      </tr>
    </thead>
    <tbody>
      {% for tx in transactions %}
      {% set display_date = tx.posting_datetime or tx.transaction_datetime or tx.created_at %}
      {% set date_badge = "P" if tx.posting_datetime else ("T" if tx.transaction_datetime else "C") %}
      {% set source_count = tx.source_links|length %}
      <tr class="hover cursor-pointer"
          onclick="window.location='/transactions/{{ tx.id }}'">
        <td class="whitespace-nowrap">
          <span>{{ display_date.strftime('%Y-%m-%d') }}</span>
          <span class="badge badge-ghost badge-xs ml-1" title="{{ 'Posting' if date_badge == 'P' else ('Transaction' if date_badge == 'T' else 'Created') }}">{{ date_badge }}</span>
        </td>
        <td>
          <div class="font-medium">{{ tx.description|truncate(40) }}</div>
          {% if tx.location %}
          <div class="text-xs text-base-content/60">{{ tx.location }}</div>
          {% endif %}
        </td>
        <td class="whitespace-nowrap text-sm">
          {% if tx.card %}****{{ tx.card.card_masked_number[-4:] }}{% endif %}
        </td>
        <td>
          <span class="badge badge-outline badge-sm">{{ tx.transaction_kind }}</span>
        </td>
        <td class="text-right whitespace-nowrap font-mono {{ 'text-error' if tx.amount < 0 else 'text-success' }}">
          {{ "{:,.2f}".format(tx.amount) }} {{ tx.currency }}
          {% if tx.original_currency and tx.original_currency != tx.currency %}
          <div class="text-xs text-base-content/50">{{ "{:,.2f}".format(tx.original_amount) }} {{ tx.original_currency }}</div>
          {% endif %}
        </td>
        <td class="text-center">
          <span class="badge badge-sm {{ 'badge-primary' if source_count > 1 else 'badge-ghost' }}">{{ source_count }}</span>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{# ===== Mobile card list (hidden on desktop) ===== #}
<div class="lg:hidden space-y-3">
  {% for tx in transactions %}
  {% set display_date = tx.posting_datetime or tx.transaction_datetime or tx.created_at %}
  {% set date_badge = "P" if tx.posting_datetime else ("T" if tx.transaction_datetime else "C") %}
  {% set source_count = tx.source_links|length %}
  <a href="/transactions/{{ tx.id }}" class="card bg-base-100 shadow-sm hover:shadow-md transition-shadow">
    <div class="card-body p-4">
      <div class="flex justify-between items-start gap-2">
        <div class="min-w-0 flex-1">
          <div class="flex items-center gap-2 text-sm text-base-content/60 mb-1">
            <span>{{ display_date.strftime('%d %b') }}</span>
            <span class="badge badge-ghost badge-xs">{{ date_badge }}</span>
          </div>
          <div class="font-medium truncate">{{ tx.description }}</div>
          <div class="flex flex-wrap items-center gap-1 mt-1 text-xs text-base-content/60">
            {% if tx.card %}
            <span>****{{ tx.card.card_masked_number[-4:] }}</span>
            <span>&bull;</span>
            {% endif %}
            <span>{{ tx.transaction_kind }}</span>
            <span>&bull;</span>
            <span>{{ source_count }} source{{ 's' if source_count != 1 }}</span>
          </div>
        </div>
        <div class="text-right shrink-0">
          <div class="font-mono font-semibold {{ 'text-error' if tx.amount < 0 else 'text-success' }}">
            {{ "{:,.2f}".format(tx.amount) }}
          </div>
          <div class="text-xs text-base-content/60">{{ tx.currency }}</div>
        </div>
      </div>
    </div>
  </a>
  {% endfor %}
</div>

{# ===== Pagination ===== #}
{% if total_pages > 1 %}
<nav class="flex justify-center mt-6" aria-label="Pagination">
  <div class="join">
    {% if page > 1 %}
    <button class="join-item btn btn-sm"
            hx-get="/transactions?page={{ page - 1 }}&per_page={{ per_page }}"
            hx-target="#results-container"
            hx-push-url="true"
            hx-include="#filters-form">
      &laquo; Prev
    </button>
    {% endif %}

    {% set start_page = [1, page - 2]|max %}
    {% set end_page = [total_pages, page + 2]|min %}

    {% if start_page > 1 %}
    <button class="join-item btn btn-sm"
            hx-get="/transactions?page=1&per_page={{ per_page }}"
            hx-target="#results-container"
            hx-push-url="true"
            hx-include="#filters-form">1</button>
    {% if start_page > 2 %}
    <span class="join-item btn btn-sm btn-disabled">…</span>
    {% endif %}
    {% endif %}

    {% for p in range(start_page, end_page + 1) %}
    <button class="join-item btn btn-sm {{ 'btn-active' if p == page }}"
            hx-get="/transactions?page={{ p }}&per_page={{ per_page }}"
            hx-target="#results-container"
            hx-push-url="true"
            hx-include="#filters-form">{{ p }}</button>
    {% endfor %}

    {% if end_page < total_pages %}
    {% if end_page < total_pages - 1 %}
    <span class="join-item btn btn-sm btn-disabled">…</span>
    {% endif %}
    <button class="join-item btn btn-sm"
            hx-get="/transactions?page={{ total_pages }}&per_page={{ per_page }}"
            hx-target="#results-container"
            hx-push-url="true"
            hx-include="#filters-form">{{ total_pages }}</button>
    {% endif %}

    {% if page < total_pages %}
    <button class="join-item btn btn-sm"
            hx-get="/transactions?page={{ page + 1 }}&per_page={{ per_page }}"
            hx-target="#results-container"
            hx-push-url="true"
            hx-include="#filters-form">
      Next &raquo;
    </button>
    {% endif %}
  </div>
</nav>
{% endif %}

{% endif %}

{# Loading indicator for HTMX #}
<div class="htmx-indicator flex justify-center py-8">
  <span class="loading loading-spinner loading-lg"></span>
</div>
