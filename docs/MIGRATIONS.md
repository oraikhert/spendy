# Database migrations

The project uses Alembic to manage the database schema.

## Quick start

### Initial setup (already done)

```bash
alembic init alembic
```

### Create first migration

After defining models in `app/models/`:

```bash
alembic revision --autogenerate -m "Initial migration: create users table"
```

### Apply migrations

```bash
alembic upgrade head
```

## Commands

| Action | Command |
|--------|---------|
| Create migration after model changes | `alembic revision --autogenerate -m "description"` |
| Apply all migrations | `alembic upgrade head` |
| Roll back last migration | `alembic downgrade -1` |
| Roll back to a revision | `alembic downgrade <revision_id>` |
| Roll back all | `alembic downgrade base` |
| Show history | `alembic history` |
| Current revision | `alembic current` |
| Show SQL without applying | `alembic upgrade head --sql` |

Example — new table:
```bash
alembic revision --autogenerate -m "Add transactions table"
```

## Workflow

1. **Change models** in `app/models/`
2. **Create migration:** `alembic revision --autogenerate -m "description"`
3. **Review** the file in `alembic/versions/`
4. **Apply:** `alembic upgrade head`

## Migration history

| Revision | Description |
|----------|-------------|
| (base) | — |
| cfc042908370 | Initial: users table |
| trans001 | Transaction domain: accounts, cards, transactions, source_events, transaction_source_links |
| parsed_card_001 | Add source_events.parsed_card_number (String 4) |
| drop_orig_001 | Drop source_events.parsed_original_amount, parsed_original_currency |

Files: `alembic/versions/cfc042908370_*.py`, `trans001_add_transaction_tables.py`, `add_parsed_card_number.py`, `drop_parsed_original_from_source_events.py`.

## Important notes

### Review autogenerated migrations

Alembic does not always generate perfect migrations. Always check:

- Data types
- Indexes and constraints
- Defaults
- Nullable vs NOT NULL

### Migrations that change existing data

If the migration touches existing rows, handle defaults in steps:

```python
def upgrade() -> None:
    # Add column as nullable first
    op.add_column('users', sa.Column('phone', sa.String(20), nullable=True))
    
    # Backfill
    op.execute("UPDATE users SET phone = '' WHERE phone IS NULL")
    
    # Then make NOT NULL
    op.alter_column('users', 'phone', nullable=False)
```

### SQLite limits

SQLite has limited ALTER TABLE support:

- No DROP COLUMN (before 3.35.0)
- Limited ALTER COLUMN
- Sometimes you must recreate the table

For SQLite you may need:

```python
def upgrade() -> None:
    with op.batch_alter_table('users') as batch_op:
        batch_op.add_column(sa.Column('new_field', sa.String(50)))
```

## Switching to PostgreSQL

1. Create the database in PostgreSQL.
2. Set `DATABASE_URL` in `.env`.
3. Run: `alembic upgrade head`

The schema will be applied to the new database.

## Example migration

```python
"""Add email verification

Revision ID: abc123def456
Revises: previous_revision
Create Date: 2026-02-06 10:00:00

"""
from typing import Sequence, Union
from alembic import op
import sqlalchemy as sa

revision: str = 'abc123def456'
down_revision: Union[str, None] = 'previous_revision'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    op.add_column('users', 
        sa.Column('email_verified', sa.Boolean(), 
                  nullable=False, server_default='0')
    )
    op.add_column('users', 
        sa.Column('verification_token', sa.String(255), 
                  nullable=True)
    )


def downgrade() -> None:
    op.drop_column('users', 'verification_token')
    op.drop_column('users', 'email_verified')
```

## Troubleshooting

### Conflicting revisions

If several developers created migrations:

```bash
alembic merge heads -m "merge migrations"
```

### Reset migrations (development only)

```bash
alembic downgrade base
rm alembic/versions/*.py
rm spendy.db
alembic revision --autogenerate -m "Initial migration"
alembic upgrade head
```

### Edit alembic_version by hand

Only for development, in extreme cases:

```sql
DELETE FROM alembic_version;
INSERT INTO alembic_version (version_num) VALUES ('revision_id');
```
